
netdiscover로 우리가 접속한 네크워크를 매핑할 수 있다.
우선 칼리에서 터미널을 연다.
ifconfig를 입력하여 현재 네트워크를 확인한다.
inet 이후에 나오는 것이 ip주소이다.
현재 네트워크에 연결된 모든 기기를 확인하기 위해선 
netdiscover -r(찾는 위로 주로 액세스할 수 있는 ip주소를 입력)
ip는 192.168.136.128 이렇게 4개의 .으로 이루어지는데 
앞에 3가지는 동일네트워크. 이후 128위치에는 0~255에서 끝난다.
그래서netdiscover -r 192.168.136.1/24를 하면 전체 서브넷의 ip범위인 1.~254.까지 다 찾아준다.
마지막 자리가 0부터 시작할 수 있지만 0은 찾지 않는 이유는
0은 네트워크 자체를 나타내므로 호스트 주소로 사용되지 않고
255는 브로드캐스트 용도로 예약되어서 사용하지 않는다.
해당 클라이언트 목록이 나오면 q를 누르면 빠져나온다.

enmap의 경우는 netdiscover보다 발전된 도구로 netdiscover보다 느리지만 더 많은 정보를 보여준다.
그 포트에서 실행되고 있는 프로그램이나 운영체계 등도 알 수 있고 보안과 방화벽 우회까지 가능
enmap의 그래픽유저 프로그램인 zenmap을 터미널에서 호출하면 사용할 수 있다.
프로그램에 target란에는 ip 입력 시 스캔가능.
모든 개방된 포트를 확인하고 
타겟에는 ip를 입력하는데 특정 ip말고 주변의 모든 ip를 검색할 경우 netdiscover처럼 192.168.136.1/24를 하면 전체 다 확인할 수 있다.
바로 밑 하단에는 command란이 있다.
직접 커맨드를 입력해도 되고 커맨드를 모를 시 옆에 profile을 눌러서 기능을 사용할 수 있다.'
ping scan은 맥주소와 ip, 제조사를 보여준다.
quick scan을 하면 발견된 기기들(ip)의 개방된 포트도 보여준다.
quick scan plus는 quick scan보다 더 많은 정보를 보여준다. 운영체제는 어떤 것인지 데스크톱인지 노트북인지, 열린 포트에서 어떤 프로그램을 사용하고 버전의 정보까지.
기기가 모바일 폰이고 ios를 운영체제로 하는데 ssh를 쓰는 경우에는 탈옥한 폰으로 해당 프로그램에 ssh

ARP포이즈닝
중간자 공격으로 통신을 가로챌 수 있을 때하는 공격이다.
ARP스푸핑은 패킷 흐름을 리디렉션한다. 대상자가 액세스포인트(라우터)에 요청하여 응답받는 방식에서 내 컴퓨터를 거쳐 요청, 응답 받는 방식.
이런 공격이 가능한 이유는 ARP가 그다지 안전하지 않기 때문이다.

같은 네트워크 하에서는 ip주소를 알아야하는 것이 아니라 기기의 mac주소를 알아야 통신이 가능다.
arp 요청자가 특정 ip에 대한 정보를 요청하면 해당 ip의 기기는 자신의 ip와 mac주소로 응답하는 방식이다.
터미네이터에서
arp -a를 입력하면 arp테이블이 나온다.
gateway 뒤 ()부분은 ip, at 뒤에 나오는 부분은 mac주소다.

arpspoof 도구를 쓰면 arp스푸핑을 할 수 있다.
arp는 ip로 mac주소를 찾게 해주는(맵핑)하는 기술이다.
터미네이터에서 
arpspoof -i eth0(대상 인터페이스, 장비) -t 10. 0. 2. 7.(라우터 ip) 10. 0. 2. 1.(공격대상 ip)
동시에 터미네이터를 스플릿(분리)해서 
arpspoof -i eth0(대상 인터페이스, 장비) -t 10. 0. 2. 1.(공격대상 ip) 10. 0. 2. 7.(라우터 ip)
두 커맨드를 친다.
즉 라우터에게는 내가 공격대상 ip라고 알리고, 공격대상에게는 내가 라우터 ip라고 알라는 것임.
해당 공격은 이더넷, wi-fi와 무선네트워트에서 통한다.
하지만 공격대상에서 라우터가 아닌 내게 패킷을 보내면 리눅스 보안으로 자동으로 중단 시킴.
이를 위해서는 패킷을 통과시켜주는 포트 포워딩을 활성화해야한다.
터미네이터에서
echo 1 > /proc/sys/net/ipv4/ip_forward 커맨드를 입력해줘야한다.

arp스푸핑에서 한단계 발전한 것이 bettercap이다.
bettercap은 데이터 캡처, 사용자 이름, 패스워드를 중간에서 가로챌 수 있다.
터미네이터에서 bettercap --help 커맨드 시 도움말 전체를 볼 수잇다.
bettercap -iface eth0(대상인터페이스) 커맨드시 bettercap을 통한 스푸핑이 된다.
인터페이스는 ifconfig 커맨드 시 확인 가능.
bettercap 실행되면 아래에 모듈 창이 있고 실행 중인 bettercap 도구들을 볼 수 있다.
events.stream은 정상적으로 도구들이 실행되고 있음을 보여주는 상태임
모듈에 기능을 알고 싶으면 해당 상태에서 help net.probe(net.probe의 도움말을 보여줌)
net.probe는 udp패킷을 계속 전송, 동일 네트워크에 있는 기기를 확인.
on/off 모드가 있음.
이후 help를 치면 도움말도 나오지만 아래에 활성화 중인 모듈들도 볼 수 있음.
net.probe 활성화 시 net.recon도 자동활성화 되는데 net.recon은 arp캐시를 모니터링해서 probe가 주변 기기를 찾는데 보넨 요청에 응답을 탐지하고 탐지된 ip들을 리스트화 한다.
리스트된 것들을 보기위해서는 net.show라고 커맨드하면 연결된 클라이언트 모두 볼 수 있다.
ip, mac주소, 제조사 등

beetercap으로 arp스푸핑하는 법
arp.spoof. on 을 커맨드하면 모듈 작동이된다.
help arp.spoof를 커맨드하면 도움말이 나오는데 아래에 parameters를 보면 모듈에 대해 설정할 수 있는 옵션이 나온다.
파라미터에 있는 모듈 값 변경은
Set 커맨드를 치면된다.
ex) set arp.spoof.fullduplex. ture(평소에는 false 모드)
fullduplex 기능을 사용하면 라우터와 공격대상 기기 사이에 내 기기가 모든 데이터를 스푸핑할 수 있게됨.
스푸핑한 데이터는 분석 가능한데 bettercap에서는 net.sniff라는 모듈로 가능.
bettercap 작동 하에서 net.sniff on 커맨드 시 캡처한 것들은 분석해줌.

이 모든 작업이 귀찮을 경우 캐플릿을 이용하면 된다.
캐플릿은 텍스트 파일로 만들 수 있다.
net.probe.on (해당 네트워크, 라우터에 관련된 모든 클라이언트를 보여준다.)
set arp.spoof.fullduplex true (대상 클라이언트와 라우터 양 쪽에 내 ip로 송수신 받는 곳을 위장)
set arp.spoof.targets 192. 10. 2. 117(대상 클라이언트 ip를 지정함. 다수 클라이언트 대상일 경우 첫 ip주소 다음에 , 하고 입력)
arp spoof. on(spoof를 작동)
net.sniff on(대상 클라이언트와 라우터 사이에 데이터를 스니핑함)
해당 파일을 root 디렉터리에 넣고 spoof.cap으로 저장해줌.
터미네이터에서 
pwd 커맨드
최상위 root 디렉터리로 간다
ls를 커맨드하면 
현재 root 디렉터리 하에 모든 파일, 폴더를 보여준다.
여기에 spoof.cap이 있음을 확인.
이후 bettercap을 실행, 아래 커맨
bettercap -iface eth0(타겟 네트워크에 연결된 인터페이스를 지정) -caplet /root/spoof.cap(캐필릿용 파일명과 디렉터리을 입력)
이 방법은 http 하에서만 가능. https에서는 안된다.

https를 우회하는 법
https는 tls, ssl로 보안처리되어 있기에 우회는 법은 https를 http로 다운그레이트 시키는 방법이다.
bettercap을 통해 중간에서 arp를 spoof 했기에 대상이 https를 요청해도 나는 https가 아닌 http를 제공하여 대상이 http로 다시금 요청하게 한다.
bettercap에서는 해당 기능의 캐플릿도 있다.
이전에 만든 캐플릿 텍스트 파일을 수정.

net.probe.on (해당 네트워크, 라우터에 관련된 모든 클라이언트를 보여준다.)
set arp.spoof.fullduplex true (대상 클라이언트와 라우터 양 쪽에 내 ip로 송수신 받는 곳을 위장)
set arp.spoof.targets 192. 10. 2. 117(대상 클라이언트 ip를 지정함. 다수 클라이언트 대상일 경우 첫 ip주소 다음에 , 하고 입력)
arp spoof. on(spoof를 작동)
set net.sniff.local true(해당 데이터가 로컬데이터라고 생각되어도 bettercap에서 모든 데이터 스니핑하도록 지시, 즉 클라이언트가 https로 보내려하면 bettercap이 tls연결을 가로챈 뒤 자체 종료시키고 bettercap서버에서 제공하는 가짜 https링크로 변)
net.sniff on(대상 클라이언트와 라우터 사이에 데이터를 스니핑함)

위 수정된 캐플릿 텍스트파일에
bettercap -iface eth0(타겟 네트워크에 연결된 인터페이스를 지정) -caplet /root/spoof.cap(캐필릿용 파일명과 디렉터리을 입력)
입력 후 help를 커맨드하면 정상 작동하는지 알 수 있다.
하지만 https가 아닌 http로 다운그레이드 시킨 것들의 정보를 가져오려면 hst바이패스 캐플릿이 필요.
여기서 caplets.show 커맨드를 입력
다양한 캐플릿들 도구들이 나오는데 이때 
hstshijack/hstshijack 를 사용해야하므로 
해당 네임인 hstshijack/hstshijack 직접 타이핑 혹은 h를 치고 tab을 눌러 자동완성을 하여 실행
왠만한 사이트는 되지만 페이스북 같은 개인정보가 중요한 곳은 hst로 우회한다.

hsts는 https를 강제한다. 해당 기능은 브라우저에서 해당 사이트에서 요청하기에 자동으로 하는 것임.
결국 hsts 우회는 브라우저가 다른 웹사이트를 로드한다고 생각하게 하는 것임.
이를 위해 유사링크로 보낸다. 예를 들어 facebook.com-facebook.corn

hstshijack 캐플릿에 .cap 파일을 leappad를 통해 열면'
targets는 대상사이트, replacemets는 대체 사이트이다.
모데인 옆에*(별표)는 와일드카드로 모든 하위 도메인에도 적용한다는 뜻임.
obfuscate(오퍼스케이트)는 난독하게 만들어서 컴퓨터에서 쉽게 악성코드를 못찾게 함.
파이어폭스 같은 일부 브라우저에서는 오퍼스케이트와 인코딩 된 코드가 차단되기도 함.
페이로드는 hstshijack을 하면서 다른 javascript 코드를 설정할 수 있다. 

hstshiack 캐플릿에 설정이 완벽하게 되어 있지 않으면 주소표시창에 도메인을 입력시 가로챌 순 없다.
대신에 구글 같은 검색엔진에서 해당 사이트 검색, 표시되는 사이트에 마우스를 가져가면 상태표시줄에 로드되는 웹사이트 주소가 대체사이트로 바뀌어 있음.







